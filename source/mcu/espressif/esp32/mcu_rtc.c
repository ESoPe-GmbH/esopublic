// Urheberrecht 2018-2020 ESoPe GmbH, Alle Rechte vorbehalten
/***
 * @file mcu_rtc.c
 * @copyright Urheberrecht 2018-2020 ESoPe GmbH, Alle Rechte vorbehalten. Released under an Apache 2.0 license.
 **/

#include "../../mcu.h"

#if MCU_TYPE == MCU_ESP32 && MCU_PERIPHERY_ENABLE_RTC

#include "../../sys.h"
#include "module/rtc/rtc.h"
#include "mcu_internal.h"
#include <sys/time.h>

//-----------------------------------------------------------------------------------------------------------------------------------------------------------
// Internal definitions
//-----------------------------------------------------------------------------------------------------------------------------------------------------------


//-----------------------------------------------------------------------------------------------------------------------------------------------------------
// Internal structures and enums
//-----------------------------------------------------------------------------------------------------------------------------------------------------------


//-----------------------------------------------------------------------------------------------------------------------------------------------------------
// Internal variables
//-----------------------------------------------------------------------------------------------------------------------------------------------------------


//-----------------------------------------------------------------------------------------------------------------------------------------------------------
// Prototypes
//-----------------------------------------------------------------------------------------------------------------------------------------------------------

//-----------------------------------------------------------------------------------------------------------------------------------------------------------
// External Functions
//-----------------------------------------------------------------------------------------------------------------------------------------------------------
void mcu_rtc_init(bool use_ext_subclock)
{

}

void mcu_rtc_set_time(rtc_time_t *time)
{
	struct timeval now = { 0 };
	struct tm t2 = {
		.tm_sec = time->tm_sec,
		.tm_min = time->tm_min,
		.tm_hour = time->tm_hour,
		.tm_mday = time->tm_mday,
		.tm_mon = time->tm_mon,
		.tm_year = time->tm_year,
		.tm_wday = time->tm_wday,
		.tm_yday = time->tm_yday,
		.tm_isdst = time->tm_isdst,
	};
	now.tv_sec = mktime(&t2);
	now.tv_usec = (uint32_t)time->tm_msec * 1000;
	settimeofday(&now, NULL);
}

void mcu_rtc_get_time(rtc_time_t *t)
{
	struct timeval now2 = { 0 };
	gettimeofday(&now2, NULL);
	struct tm* localtm = localtime(&now2.tv_sec);
	
	t->tm_sec = localtm->tm_sec;
	t->tm_min = localtm->tm_min;
	t->tm_hour = localtm->tm_hour;
	t->tm_mday = localtm->tm_mday;
	t->tm_mon = localtm->tm_mon;
	t->tm_year = localtm->tm_year;
	t->tm_wday = localtm->tm_wday;
	t->tm_yday = localtm->tm_yday;
	t->tm_isdst = localtm->tm_isdst;
	t->tm_msec = now2.tv_usec / 1000;
}

//-----------------------------------------------------------------------------------------------------------------------------------------------------------
// Internal Functions
//-----------------------------------------------------------------------------------------------------------------------------------------------------------

#endif
